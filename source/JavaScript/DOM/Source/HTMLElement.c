// LICENSE NOTICE ==================================================================================

/**
 * Netzhaut - Web Browser Engine
 * Copyright (C) 2020  Dajo Frey
 * Published under LGPLv3
 */

// INCLUDE ========================================================================================

#include "../Header/HTMLElement.h"
#include "../Header/HTMLCanvasElement.h"
#include "../Header/EventListener.h"
#include "../Header/Document.h"
#include "../Header/Macros.h"

#include "../../Core/Header/Object.h"

#include "../../../Core/Header/String.h"
#include "../../../Core/Header/Memory.h"
#include "../../../Core/Header/Config.h"
#include "../../../Core/Header/HashMap.h"

#include <ctype.h>

#include NH_UTILS
#include NH_CUSTOM_CHECK
#include NH_JS_DEBUG_FUNCTION

// API =============================================================================================

Nh_JS_Result NH_JS_HTML_ELEMENT_HTMLElement(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_accessKey(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_accessKeyLabel(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_contentEditable(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_isContentEditable(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_contextMenu(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_dataset(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_dir(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_draggable(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_dropzone(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_hidden(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_inert(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_innerText(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_itemScope(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_itemType(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_itemId(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_itemRef(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_itemProp(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_itemValue(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_lang(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_noModule(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_nonce(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_offsetHeight(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_offsetLeft(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_offsetParent(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_offsetTop(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_offsetWidth(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_properties(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_spellcheck(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_style(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_tabIndex(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_title(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_translate(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_attachInternals(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_blur(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_click(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_focus(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_forceSpellCheck(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_selected(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

    if (aCount == 0) // get
    {
        Nh_JS_HTMLElement *Element_p = Function_p->Inherit_p->data_p;
        NH_END(Nh_JS_getResult(
            Element_p->Node_p->Computed.Attributes.selected ? NH_JS_TYPE_BOOLEAN_TRUE : NH_JS_TYPE_BOOLEAN_FALSE,
            false, NULL
        ))
    }
    else if (aCount == 1) // set
    {
        Nh_JS_HTMLElement *Element_p = Nh_JS_getObject(Function_p->Inherit_p, NH_JS_OBJECT_HTML_ELEMENT)->data_p;

        if (Arguments_p[0].type == NH_JS_TYPE_BOOLEAN_TRUE) {
            Nh_HTML_addAttribute(&Element_p->Node_p->Attributes, NH_HTML_ATTRIBUTE_SELECTED, NULL);
        } 
        else if (Arguments_p[0].type == NH_JS_TYPE_BOOLEAN_FALSE) {
            Nh_HTML_removeAttribute(&Element_p->Node_p->Attributes, NH_HTML_ATTRIBUTE_SELECTED);
        }

        Nh_HTML_updateAttributes(Script_p->Run.Tab_p, Element_p->Node_p);
    }

NH_END(Nh_JS_getNULLResult())
}

Nh_JS_Result NH_JS_HTML_ELEMENT_value(
    Nh_JS_Script *Script_p, Nh_JS_Object *Function_p, int aCount, Nh_JS_Result *Arguments_p)
{
NH_BEGIN()

    if (aCount == 0) // get
    {
        Nh_JS_HTMLElement *Element_p = Function_p->Inherit_p->data_p;
        NH_END(Nh_JS_getResult(
            NH_JS_TYPE_STRING, false, Element_p->Node_p->Computed.Attributes.value_p 
        ))
    }
    else if (aCount == 1 && Arguments_p[0].type == NH_JS_TYPE_STRING) // set
    {
        Nh_JS_HTMLElement *Element_p = Function_p->Inherit_p->data_p;

        char *text_p = Nh_allocate(sizeof(char) * (strlen(Arguments_p[0].data_p) + 1));
        NH_CHECK_NULL(Nh_JS_getNULLResult(), text_p)
        strcpy(text_p, Arguments_p[0].data_p);

        Nh_HTML_addAttribute(&Element_p->Node_p->Attributes, NH_HTML_ATTRIBUTE_VALUE, text_p);
        Nh_HTML_updateAttributes(Script_p->Run.Tab_p, Element_p->Node_p);
    }

NH_END(Nh_JS_getNULLResult())
}

// INTERNAL ========================================================================================

#include NH_DEFAULT_CHECK
#include NH_JS_DEBUG

NH_RESULT Nh_JS_createHTMLElementObject(
    Nh_JS_Script *Script_p, Nh_JS_Object **Object_pp, Nh_HTML_Node *Node_p, Nh_JS_Object *Parent_p)
{
NH_BEGIN()

    NH_CHECK(Nh_JS_createObject(Script_p, NH_JS_OBJECT_HTML_ELEMENT, Object_pp))
    NH_CHECK(Nh_JS_createHTMLElementData(Script_p, *Object_pp, Node_p, Parent_p))

NH_END(NH_SUCCESS)
}

void Nh_JS_destroyHTMLElementObject(
    Nh_JS_Object *Object_p)
{
NH_BEGIN()

    Nh_JS_HTMLElement *Element_p = Object_p->data_p;

    for (int i = 0; i < Element_p->Children.count; ++i) {
        Nh_JS_destroyHTMLElementObject(Nh_getListItem(&Element_p->Children, i));
    }

    Nh_JS_destroyHTMLElementData(Object_p);
    Nh_JS_destroyObject(Object_p);

NH_SILENT_END()
}

NH_RESULT Nh_JS_createHTMLElementData(
    Nh_JS_Script *Script_p, Nh_JS_Object *Object_p, Nh_HTML_Node *Node_p, Nh_JS_Object *Parent_p)
{
NH_BEGIN()

    Object_p->data_p = Nh_allocate(sizeof(Nh_JS_HTMLElement));
    NH_CHECK_MEM(Object_p->data_p)

    Nh_JS_HTMLElement *Element_p = Object_p->data_p;

    Element_p->Node_p   = Node_p;
    Element_p->Parent_p = Parent_p;
    NH_INIT_LIST(Element_p->Children)

    if (Parent_p != NULL) {
        Nh_JS_HTMLElement *ParentElement_p = Nh_JS_getObject(Parent_p, NH_JS_OBJECT_HTML_ELEMENT)->data_p;
        NH_CHECK(Nh_addListItem(&ParentElement_p->Children, Object_p))
    }

NH_END(NH_SUCCESS)
}

void Nh_JS_destroyHTMLElementData(
    Nh_JS_Object *Object_p)
{
NH_BEGIN()

    Nh_destroyList(&((Nh_JS_HTMLElement*)Object_p->data_p)->Children, false);
    Nh_free(Object_p->data_p);

NH_SILENT_END()
}

Nh_JS_Object *Nh_JS_getHTMLElementObject(
    Nh_JS_Script *Script_p, Nh_HTML_Node *Node_p)
{
NH_BEGIN()
  
    if (!Script_p->Flags.loaded) {NH_END(NULL)}

    Nh_JS_Document *Document_p = Script_p->DOM.Objects.Document_p->data_p;

    for (int i = 0; i < Document_p->Tree.Flat.count; ++i) {
        Nh_JS_Object *Object_p = Nh_getListItem(&Document_p->Tree.Flat, i);
        if (((Nh_JS_HTMLElement*)Object_p->data_p)->Node_p == Node_p) {NH_END(Object_p)}
    }

NH_END(NULL)
}

#include NH_CUSTOM_CHECK

char *Nh_JS_stringifyHTMLElementData(
    Nh_JS_Object *Object_p, bool newline)
{
NH_BEGIN()

    if (Object_p->type != NH_JS_OBJECT_HTML_ELEMENT) {NH_END(NULL)}

    Nh_String *String_p = Nh_allocateString(NULL);

    Nh_JS_HTMLElement *Element_p = Object_p->data_p;
    NH_CHECK(NULL, Nh_appendFormatToString(String_p, "%s", NH_HTML_TAGS_PP[Element_p->Node_p->tag]))

    if (newline) {NH_CHECK(NULL, Nh_appendToString(String_p, "\n"))}

    char *chars_p = Nh_getChars(String_p);
    Nh_freeString(String_p, false);

NH_END(chars_p)
}

